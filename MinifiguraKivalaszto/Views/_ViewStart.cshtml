@{
    Layout = "~/DesktopModules/MVC/MinifiguraKivalaszto/Views/Shared/_Layout.cshtml";
}

<div id="figuraKeszitoModule_<%= ModuleId %>" class="figura-keszito-modul">
    <div class="figura-keszito-container">
        <div id="figuraKeszitoPanel_<%= ModuleId %>" class="panel-bal">
            <h3 class="panel-bal-fo-cim">Figura előnézete</h3>

            <div class="alkatresz-kategoria-szekcio" id="szekcioHajSapka_<%= ModuleId %>">
                <img id="figuraKeszitoHajSapka_<%= ModuleId %>" src="/Portals/0/Hotcakes/Data/products/e0b16554-1ac6-4e68-aa22-0095ad977f71/medium/lightginger-very-straight-centreparted-bob-front_480x480.png" alt="Haj/Sapka" class="figura-keszito-resz-hajsapka figura-keszito-resz"/>
            </div>

            <div class="alkatresz-kategoria-szekcio" id="szekcioFej_<%= ModuleId %>">
                <img id="figuraKeszitoFej_<%= ModuleId %>" src="/Portals/0/Hotcakes/Data/products/bc576fa2-1017-4ea9-9b24-0db8e2064d80/medium/HugeSmileRedLipstick-Y_480x480.png" alt="Fej" class="figura-keszito-resz-fej figura-keszito-resz"/>
            </div>

            <div class="alkatresz-kategoria-szekcio" id="szekcioFelsoTest_<%= ModuleId %>">
                <img id="figuraKeszitoFelsoTest_<%= ModuleId %>" src="/Portals/0/Hotcakes/Data/products/03b06476-7020-4f5d-a035-07b028f0c0ed/medium/PRODimage_dec53acb-debd-43d7-afb5-e18649070aa3_480x480.png" alt="Felső Test" class="figura-keszito-resz-felsotest figura-keszito-resz" />
            </div>

            <div class="alkatresz-kategoria-szekcio" id="szekcioLab_<%= ModuleId %>">
                <img id="figuraKeszitoLab_<%= ModuleId %>" src="/Portals/0/Hotcakes/Data/products/688f4166-f3a7-41fa-943b-0360e74a4845/medium/Blue_480x480.png" alt="Láb" class="figura-keszito-resz-lab figura-keszito-resz" />
                
            </div>

            <div class="alkatresz-kategoria-szekcio" id="szekcioEszkoz_<%= ModuleId %>">
                <img id="figuraKeszitoEszkoz_<%= ModuleId %>" src="/Portals/0/Hotcakes/Data/products/89edc98a-354c-46c6-a5d6-386c2324c94c/medium/browncase-1_b4e59048-d3b1-4a6e-94e2-67236bf0b0f9_480x480.png" alt="Eszköz" class="figura-keszito-resz-eszkoz figura-keszito-resz" />
            </div>

        </div>

        <div class="panel-jobb">

            <div id="kategoriaValasztoGombok_<%= ModuleId %>" class="kategoria-gombok">
                <button type="button" class="kategoria-gomb" data-kategoria="HajSapka">Haj/Sapka</button>
                <button type="button" class="kategoria-gomb" data-kategoria="Fej">Fej</button>
                <button type="button" class="kategoria-gomb" data-kategoria="FelsoTest">Felső Test</button>
                <button type="button" class="kategoria-gomb" data-kategoria="Eszkoz">Eszköz</button>
                <button type="button" class="kategoria-gomb" data-kategoria="Lab">Láb</button>
            </div>

            <div class="figura-lapozo-container">
                <button type="button" class="lapozo-gomb" id="balGomb_<%= ModuleId %>">◀</button>

                <div id="figuraElonezet_<%= ModuleId %>" class="figura-elonezet">
                    <div id="elonezetDivLab_<%= ModuleId %>" class="figura-resz-div" style="display: none;">
                        <img id="elonezetLab_<%= ModuleId %>" src="/Portals/0/Hotcakes/Data/products/688f4166-f3a7-41fa-943b-0360e74a4845/medium/Blue_480x480.png" alt="Láb" class="figura-resz" />
                    </div>
                    <div id="elonezetDivFelsoTest_<%= ModuleId %>" class="figura-resz-div" style="display: none;">
                        <img id="elonezetFelsoTest_<%= ModuleId %>" src="/Portals/0/Hotcakes/Data/products/03b06476-7020-4f5d-a035-07b028f0c0ed/medium/PRODimage_dec53acb-debd-43d7-afb5-e18649070aa3_480x480.png" alt="Felső Test" class="figura-resz" />
                    </div>
                    <div id="elonezetDivFej_<%= ModuleId %>" class="figura-resz-div" style="display: none;">
                        <img id="elonezetFej_<%= ModuleId %>" src="/Portals/0/Hotcakes/Data/products/bc576fa2-1017-4ea9-9b24-0db8e2064d80/medium/HugeSmileRedLipstick-Y_480x480.png" alt="Fej" class="figura-resz" />
                    </div>
                    <div id="elonezetDivHajSapka_<%= ModuleId %>" class="figura-resz-div" style="display: none;">
                        <img id="elonezetHajSapka_<%= ModuleId %>" src="/Portals/0/Hotcakes/Data/products/e0b16554-1ac6-4e68-aa22-0095ad977f71/medium/lightginger-very-straight-centreparted-bob-front_480x480.png" alt="Haj/Sapka" class="figura-resz" />
                    </div>
                    <div id="elonezetDivEszkoz_<%= ModuleId %>" class="figura-resz-div" style="display: none;">
                        <img id="elonezetEszkoz_<%= ModuleId %>" src="/Portals/0/Hotcakes/Data/products/89edc98a-354c-46c6-a5d6-386c2324c94c/medium/browncase-1_b4e59048-d3b1-4a6e-94e2-67236bf0b0f9_480x480.png" alt="Eszköz" class="figura-resz" />
                    </div>
                </div>

                <button type="button" class="lapozo-gomb" id="jobbGomb_<%= ModuleId %>">▶</button>
            </div>

            <div class="aktualis-elem-ar-kijelzes">
                <span>Aktuális elem ára: </span>
                <strong id="aktualisElemAr_<%= ModuleId %>">0 Ft</strong>
            </div>

            <div class="ar-kijelzes">
                <span>Összeállított figura ára: </span>
                <strong id="figuraAr_<%= ModuleId %>">0 Ft</strong>
            </div>

            <div class="muvelet-gombok">
                <button type="button" id="addToPreviewBtn_<%= ModuleId %>" class="PrimaryAction">Hozzáadás</button>
                <button type="button" id="randomBtn_<%= ModuleId %>" class="PrimaryAction">Random</button>
                <button type="button" id="addToCartBtn_<%= ModuleId %>" class="PrimaryAction">Kosárba</button>
            </div>

            <div id="figuraKeszitoUzenet_<%= ModuleId %>" class="figura-uzenet" style="display: none;">
            </div>

        </div>
    </div>


<script>
    

    document.addEventListener("DOMContentLoaded", function () {
        var ProductsInCategories = {};
        async function getProducts(categoryId) {
            try {
                // http://rendfejl10003.northeurope.cloudapp.azure.com/
                // dev :http://www.dnndev.me/
                const endPoint = "products";
                const key = "1-9f81dabb-d513-43b3-a568-13b7282b6ce0";
                const response = await fetch('http://rendfejl10003.northeurope.cloudapp.azure.com/DesktopModules/Hotcakes/API/rest/v1/' + endPoint + "?key=" + key + "&bycategory=" + categoryId, {
                    method: 'GET',
                });
                if (response.ok) {
                    const products = await response.json();
                    //console.log(products);
                    return products;
                } else {
                    console.error('API hiba:', response.statusText);
                }
            } catch (error) {
                console.error('Hiba történt a kérés során:', error);
            }
        }
        async function displayProducts() {
            // A képek elérhetősége a virtuális gépen: pl. Portals/0/Hotcakes/Data/products/c4420e40-0c66-4f1c-b1b0-9360fc369f40/medium/32_480x480.png
            const CategoryIdsDict = {
                "Fej": "6A456047-FEB7-4096-8E0D-FB4F941818D8",
                "HajSapka": "B417B28C-88E8-4E42-A53F-CC1035AF5EAC",
                "FelsoTest": "3BE4AF41-09CB-4B03-8A7C-DC74205BE878",
                //"Kez": "A31DBBA9-39D1-4313-8B3D-02A7F8A22A31",
                "Lab": "FAC5058F-DDEE-449F-A50D-6D84FC0850EF",
                "Eszkoz": "DA6D27B7-178F-4BBD-AE15-253783981012"
            };
            const productContainer = document.getElementById('product-container');

            //console.log(products.Content.Products);
            // a termékek adatai egy kifezezetten a modulra tervezett dictionaryben:
            ProductsInCategories = {
                "Fej": [],
                "HajSapka": [],
                "FelsoTest": [],
                //"Kez": [],
                "Lab": [],
                "Eszkoz": []
            };

            for (const key of Object.keys(CategoryIdsDict)) {
                const productsInCategory = await getProducts(CategoryIdsDict[key]);
                ProductsInCategories[key] = productsInCategory.Content.Products;
            }

            aktualisKategoria = "HajSapka"; 
            aktualisIndexek[aktualisKategoria] = 0; 

            const defaultButton = document.querySelector(`.kategoria-gomb[data-kategoria="${aktualisKategoria}"]`);
            if (defaultButton) {
                defaultButton.classList.add("active");
            }

            frissitKep();      
            megjelenitDiv(aktualisKategoria); 
            frissitAktualisElemAr(); 

        }
        displayProducts();


        let arak = {
            HajSapka: 890,
            Fej: 890,
            FelsoTest: 1090,
            Lab: 790,
            Eszkoz: 590 
        };

        let skuk = {
            //HajSapka: ProductsInCategories["HajSapka"][0]["Sku"],
            //Fej: ProductsInCategories["Fej"][0]["Sku"],
            //FelsoTest: ProductsInCategories["FelsoTest"][0]["Sku"],
            //Lab: ProductsInCategories["Lab"][0]["Sku"],
            //Eszkoz: ProductsInCategories["Eszkoz"][0]["Sku"]
            HajSapka: "M1_0042",
            Fej: "M2_0041",
            FelsoTest: "M3_0042",
            Lab: "M4_0009",
            Eszkoz: "MA_0004"
        }

        const moduleId = "<%= ModuleId %>";

        const sum = Object.values(arak).reduce((acc, value) => acc + value, 0);
        document.getElementById(`figuraAr_${moduleId}`).innerHTML = sum + " Ft";

        let kategoriaMaxKepekSzama = {
            HajSapka: 119,
            Fej: 94,
            FelsoTest: 47,
            Lab: 32,
            Eszkoz: 20
        };


        let aktualisKategoria = "HajSapka";
        let aktualisIndexek = {
            HajSapka: 0,
            Fej: 0,
            FelsoTest: 0,
            Lab: 0,
            Eszkoz: 0
        };

        const buttons = document.querySelectorAll(".kategoria-gomb");
        buttons.forEach(button => {
            button.addEventListener("click", function () {
                buttons.forEach(btn => {
                    btn.classList.remove("active");
                });

                this.classList.add("active");

                aktualisKategoria = this.dataset.kategoria;
                aktualisIndexek[aktualisKategoria] = 0;
                frissitKep();
                megjelenitDiv(aktualisKategoria);
                frissitAktualisElemAr();
            });
        });

        document.getElementById(`balGomb_${moduleId}`).addEventListener("click", function () {
            if (aktualisIndexek[aktualisKategoria] > 0) {
                aktualisIndexek[aktualisKategoria]--;
            }
            else if (aktualisIndexek[aktualisKategoria] == 0) {
                aktualisIndexek[aktualisKategoria] = kategoriaMaxKepekSzama[aktualisKategoria] - 1;
            }
            else {
                console.log("Negatív index!!");
            }
            frissitKep();
            frissitAktualisElemAr();
        });

        document.getElementById(`jobbGomb_${moduleId}`).addEventListener("click", function () {
            if (aktualisIndexek[aktualisKategoria] < kategoriaMaxKepekSzama[aktualisKategoria] - 1) {
                aktualisIndexek[aktualisKategoria]++;
            }
            else {
                aktualisIndexek[aktualisKategoria] = 0;
            }
            frissitKep();
            frissitAktualisElemAr();
        });

        document.getElementById(`randomBtn_${moduleId}`).addEventListener("click", function () {
            Object.keys(ProductsInCategories).forEach(kategoria => {
                const randomIndex = Math.floor(Math.random() * kategoriaMaxKepekSzama[kategoria]);
                aktualisIndexek[kategoria] = randomIndex;
                
                const index = aktualisIndexek[kategoria];
                const bvin = ProductsInCategories[kategoria][index]["Bvin"];
                const productImg = ProductsInCategories[kategoria][index]["ImageFileMedium"];
                const alapSrc = `/Portals/0/Hotcakes/Data/products/${bvin}/medium/${productImg}`;
                const targetImg = document.getElementById(`figuraKeszito${kategoria}_${moduleId}`);
                arak[kategoria] = ProductsInCategories[kategoria][index]["SitePrice"];
                skuk[kategoria] = ProductsInCategories[kategoria][index]["Sku"];
                if (targetImg) {
                    targetImg.src = alapSrc;
                }
                console.log(alapSrc);
            });

            const sum = Object.values(arak).reduce((acc, value) => acc + value, 0);
            document.getElementById(`figuraAr_${moduleId}`).innerHTML = sum + " Ft";
            frissitAktualisElemAr();
        });

        function frissitAktualisElemAr() {
            const index = aktualisIndexek[aktualisKategoria];
            if (ProductsInCategories[aktualisKategoria] && ProductsInCategories[aktualisKategoria][index]) {
                const currentItemPrice = ProductsInCategories[aktualisKategoria][index]["SitePrice"];
                document.getElementById(`aktualisElemAr_${moduleId}`).innerHTML = currentItemPrice + " Ft";
            } else {
                document.getElementById(`aktualisElemAr_${moduleId}`).innerHTML = "0 Ft"; 
            }
        }


        function frissitKep() {
            //Portals/0/Hotcakes/Data/products/c4420e40-0c66-4f1c-b1b0-9360fc369f40/medium/32_480x480.png
            const index = aktualisIndexek[aktualisKategoria];
            //console.log(ProductsInCategories[aktualisKategoria]);
            const bvin = ProductsInCategories[aktualisKategoria][index]["Bvin"];
            const productImg = ProductsInCategories[aktualisKategoria][index]["ImageFileMedium"];
            const img = document.getElementById(`elonezet${aktualisKategoria}_${moduleId}`);
            const path = `/Portals/0/Hotcakes/Data/products/${bvin}/medium/${productImg}`;
            img.src = path;
            img.style.display = "block";
            frissitAktualisElemAr()
        }

        function megjelenitDiv(kategoria) {
            document.querySelectorAll(".figura-resz-div").forEach(div => {
                div.style.display = "none";
            });
            const div = document.getElementById(`elonezetDiv${kategoria}_${moduleId}`);
            if (div) div.style.display = "block";
            frissitAktualisElemAr()
        }

        document.getElementById(`addToPreviewBtn_${moduleId}`).addEventListener("click", function () {
            const index = aktualisIndexek[aktualisKategoria];
            const bvin = ProductsInCategories[aktualisKategoria][index]["Bvin"];
            const productImg = ProductsInCategories[aktualisKategoria][index]["ImageFileMedium"];
            const src = `/Portals/0/Hotcakes/Data/products/${bvin}/medium/${productImg}`;

            // Bal oldali (kiválasztott) kép frissítése
            const targetImg = document.getElementById(`figuraKeszito${aktualisKategoria}_${moduleId}`);
            if (targetImg) {
                targetImg.src = src;
            }
            // ár hozzáadása
            console.log(ProductsInCategories[aktualisKategoria][index]["SitePrice"]);
            arak[aktualisKategoria] = ProductsInCategories[aktualisKategoria][index]["SitePrice"];
            const sum = Object.values(arak).reduce((acc, value) => acc + value, 0);

            document.getElementById(`figuraAr_${moduleId}`).innerHTML = sum + " Ft";
            skuk[aktualisKategoria] = ProductsInCategories[aktualisKategoria][index]["Sku"];
            console.log(skuk);
        });

        

        document.getElementById(`addToCartBtn_${moduleId}`).addEventListener("click", function () {
            //addToCart("M2_00002");
            window.location.href = "http://rendfejl10003.northeurope.cloudapp.azure.com/bevasarlokocsi?AddSku=" + skuk["HajSapka"] + "," + skuk["Fej"] + "," + skuk["FelsoTest"] + "," + skuk["Lab"] + "," + skuk["Eszkoz"] + "&AddSkuQty=1,1,1,1,1";
        })
        
        // http://rendfejl10003.northeurope.cloudapp.azure.com/bevasarlokocsi?AddSku=60403&AddSkuQty=1
        frissitAktualisElemAr()
    });
</script>
